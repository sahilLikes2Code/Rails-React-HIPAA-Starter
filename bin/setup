#!/usr/bin/env bash
set -euo pipefail

echo "üöÄ Setting up Rails + React HIPAA Starter..."

# Check for required tools
command -v ruby >/dev/null 2>&1 || { echo "‚ùå Ruby is required but not installed. Aborting." >&2; exit 1; }
command -v bundle >/dev/null 2>&1 || { echo "‚ùå Bundler is required but not installed. Aborting." >&2; exit 1; }
command -v yarn >/dev/null 2>&1 || { echo "‚ùå Yarn is required but not installed. Aborting." >&2; exit 1; }
command -v psql >/dev/null 2>&1 || { echo "‚ö†Ô∏è  PostgreSQL is not installed. You'll need it for the database." >&2; }

echo "‚úÖ Prerequisites check passed"

# Install Ruby dependencies
echo ""
echo "üì¶ Installing Ruby gems..."
bundle install

# Install JavaScript dependencies
echo ""
echo "üì¶ Installing JavaScript packages..."
if [ ! -f yarn.lock ]; then
  touch yarn.lock
fi
yarn install

# Create necessary directories
echo ""
echo "üìÅ Creating necessary directories..."
mkdir -p app/assets/config
mkdir -p app/assets/images
mkdir -p app/assets/builds
touch app/assets/builds/.keep

# Create manifest.js if it doesn't exist
if [ ! -f app/assets/config/manifest.js ]; then
  echo "//= link_tree ../images
//= link_directory ../stylesheets .css
//= link application.js" > app/assets/config/manifest.js
  echo "‚úÖ Created app/assets/config/manifest.js"
fi

# Set up encryption key (development only)
echo ""
echo "üîê Setting up encryption keys..."
if [ ! -f config/master.key ]; then
  echo "‚ö†Ô∏è  No master.key found. Setting up new credentials..."
  
  # If credentials.yml.enc exists but can't be decrypted, remove it
  # This happens when cloning the repo - the encrypted file exists but master.key doesn't
  if [ -f config/credentials.yml.enc ]; then
    echo "   Removing existing credentials.yml.enc (can't be decrypted without master.key)..."
    rm -f config/credentials.yml.enc
  fi
  
  # Generate new credentials using rails command
  echo "   Creating new credentials file..."
  # Set SECRET_KEY_BASE as fallback to prevent errors during credentials creation
  export SECRET_KEY_BASE=$(openssl rand -hex 64)
  
  # Create credentials file with secret_key_base and lockbox_master_key
  # Use a script that writes the content
  cat > /tmp/create_creds.rb <<'RUBY'
require 'yaml'
require 'openssl'

content = {
  secret_key_base: ENV['SECRET_KEY_BASE'] || OpenSSL::Random.hex(64),
  lockbox_master_key: OpenSSL::Random.hex(32)
}

File.write('/tmp/creds_content.yml', content.to_yaml)
RUBY
  
  ruby /tmp/create_creds.rb 2>/dev/null
  
  if [ -f /tmp/creds_content.yml ]; then
    EDITOR="cp /tmp/creds_content.yml" rails credentials:edit 2>/dev/null && {
      echo "‚úÖ Credentials and master key created"
      rm -f /tmp/creds_content.yml /tmp/create_creds.rb
    } || {
      echo "   ‚ö†Ô∏è  Could not create credentials automatically."
      echo "   You can create them manually with: rails credentials:edit"
      rm -f /tmp/creds_content.yml /tmp/create_creds.rb
    }
  else
    echo "   ‚ö†Ô∏è  Could not generate credentials content."
    echo "   You can create them manually with: rails credentials:edit"
    rm -f /tmp/create_creds.rb
  fi
else
  echo "‚úÖ Master key already exists"
fi

# Create database
echo ""
echo "üóÑÔ∏è  Setting up database..."
if rails db:create 2>/dev/null; then
  echo "‚úÖ Database created"
else
  echo "‚ö†Ô∏è  Database may already exist or there was an error"
fi

# Run migrations
echo ""
echo "üîÑ Running migrations..."
if rails db:migrate 2>/dev/null; then
  echo "‚úÖ Migrations completed"
else
  echo "‚ö†Ô∏è  No migrations to run or error occurred"
fi

# Build assets
echo ""
echo "üé® Building assets..."
yarn build:css || echo "‚ö†Ô∏è  CSS build had issues (this is okay if stylesheets don't exist yet)"

echo ""
echo "‚ú® Setup complete!"
echo ""
echo "Next steps:"
echo "  1. Update config/database.yml with your PostgreSQL credentials"
echo "  2. Run: bin/dev"
echo "  3. Visit: http://localhost:3000"
echo ""
echo "For production, make sure to:"
echo "  - Set LOCKBOX_MASTER_KEY in credentials or environment"
echo "  - Configure all HIPAA compliance requirements"
echo "  - Review HIPAA_COMPLIANCE_PLAN.md"

